<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AR Book: Jambatan Tamparuli</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
    
    /* Force Hide VR/Fullscreen Buttons */
    .a-enter-vr-button, .a-enter-ar-button { display: none !important; }

    /* Loading Screen */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center;
      flex-direction: column; color: white; transition: opacity 0.5s;
    }
    .loader {
      border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%;
      width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* UI Controls Overlay */
    #ui-layer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;
      display: none; 
    }
    
    /* Language Switcher */
    #lang-container {
      position: absolute; top: 20px; right: 20px; pointer-events: auto;
      background: rgba(0, 0, 0, 0.6); padding: 8px; border-radius: 12px;
      display: flex; gap: 8px;
    }
    .lang-btn {
      background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white;
      padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;
      transition: background 0.2s;
    }
    .lang-btn.active { background: #3498db; border-color: #3498db; }

    /* Bottom Info Panel */
    #info-panel {
      position: absolute; bottom: 30px; left: 0; width: 100%; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      pointer-events: none; 
    }

    /* Replay Button */
    #replay-btn {
      background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255,255,255,0.8); color: white;
      padding: 10px 24px; border-radius: 50px; font-size: 16px; cursor: pointer;
      margin-bottom: 15px; display: none; 
      pointer-events: auto; 
      backdrop-filter: blur(4px);
      transition: transform 0.1s, background 0.2s;
    }
    #replay-btn:active { transform: scale(0.95); background: rgba(52, 152, 219, 0.8); }

    /* Hints */
    #rotation-hint {
      color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 5px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
      background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px;
      display: none; 
    }

    #scan-guide {
      color: white; text-shadow: 1px 1px 4px black; font-size: 18px; font-weight: 600;
      padding: 0 20px; text-align: center;
    }

    /* Start Button */
    #start-btn {
      padding: 15px 30px; background: #2ecc71; color: white; border: none;
      border-radius: 50px; font-size: 18px; cursor: pointer; display: none; pointer-events: auto;
    }
  </style>

  <script>
    AFRAME.registerComponent('free-look-controller', {
      schema: { },
      init: function () {
        // Flags
        this.isMouseDown = false;
        this.isDragging = false;
        this.isPanning = false;
        
        // Coords
        this.startX = 0;
        this.startY = 0;
        this.initialPinchDistance = 0;
        this.startScale = 1;
        
        // Thresholds
        this.dragThreshold = 5; 

        // Bindings
        this.onMouseDown = this.onMouseDown.bind(this);
        this.onMouseMove = this.onMouseMove.bind(this);
        this.onMouseUp = this.onMouseUp.bind(this);
        this.onTouchStart = this.onTouchStart.bind(this);
        this.onTouchMove = this.onTouchMove.bind(this);
        this.onTouchEnd = this.onTouchEnd.bind(this);
        this.onWheel = this.onWheel.bind(this);
        this.onContextMenu = this.onContextMenu.bind(this);

        // Listeners
        window.addEventListener('mousedown', this.onMouseDown);
        window.addEventListener('mousemove', this.onMouseMove);
        window.addEventListener('mouseup', this.onMouseUp);
        
        document.addEventListener('touchstart', this.onTouchStart, {passive: false});
        document.addEventListener('touchmove', this.onTouchMove, {passive: false});
        document.addEventListener('touchend', this.onTouchEnd);
        document.addEventListener('wheel', this.onWheel, {passive: false});
        document.addEventListener('contextmenu', this.onContextMenu);
      },

      tick: function (time, timeDelta) {}, // Auto-rotate disabled

      onContextMenu: function(e) { e.preventDefault(); }, 

      // --- MOUSE LOGIC ---
      onMouseDown: function(e) {
        if(e.target.tagName !== 'BUTTON') { 
             e.preventDefault(); // Keep this PC fix!
        }

        this.isMouseDown = true;
        this.isDragging = false; 
        this.isPanning = false;

        this.startX = e.clientX;
        this.startY = e.clientY;
      },

      onMouseMove: function(e) {
        if (!this.isMouseDown) return;
        
        const deltaX = e.clientX - this.startX;
        const deltaY = e.clientY - this.startY;

        // Start Dragging check
        if (!this.isDragging && !this.isPanning) {
            const distance = Math.hypot(deltaX, deltaY);
            if (distance > this.dragThreshold) {
                if (e.button === 0) { this.isDragging = true; } 
                else if (e.button === 2) { this.isPanning = true; }
            }
        }

        if (this.isDragging) {
            this.handleOrbit(deltaX, deltaY);
            this.startX = e.clientX;
            this.startY = e.clientY;
        } 
        else if (this.isPanning) {
            this.handlePan(deltaX, deltaY);
            this.startX = e.clientX;
            this.startY = e.clientY;
        }
      },

      onMouseUp: function(e) {
        this.isMouseDown = false;
        this.isDragging = false;
        this.isPanning = false;
      },

      onWheel: function(e) {
        let zoomSpeed = e.deltaY * -0.0005; 
        this.handleZoom(zoomSpeed);
      },

      // --- TOUCH LOGIC ---
      onTouchStart: function(e) {
        if (e.touches.length === 1) {
            this.isDragging = true;
            this.startX = e.touches[0].clientX;
            this.startY = e.touches[0].clientY;
        } else if (e.touches.length === 2) {
            this.isPanning = true;
            this.startX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            this.startY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            this.initialPinchDistance = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            this.startScale = this.el.object3D.scale.x;
        }
      },

      onTouchMove: function(e) {
        if (e.touches.length === 1 && this.isDragging) {
            const deltaX = e.touches[0].clientX - this.startX;
            const deltaY = e.touches[0].clientY - this.startY;
            this.startX = e.touches[0].clientX;
            this.startY = e.touches[0].clientY;
            this.handleOrbit(deltaX, deltaY);
        } 
        else if (e.touches.length === 2 && this.isPanning) {
            const currentCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const currentCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            const deltaX = currentCenterX - this.startX;
            const deltaY = currentCenterY - this.startY;
            this.startX = currentCenterX;
            this.startY = currentCenterY;
            this.handlePan(deltaX, deltaY);

            const currentDist = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            const diff = currentDist - this.initialPinchDistance;
            const zoomFactor = diff * 0.001; 
            this.handleZoom(zoomFactor, true);
        }
      },

      onTouchEnd: function(e) {
        this.isDragging = false;
        this.isPanning = false;
      },

      // --- VIRTUAL CAMERA MATH ---
      handleOrbit: function(dX, dY) {
        this.el.object3D.rotation.y += dX * 0.005;
        this.el.object3D.rotation.x += dY * 0.005;
        this.el.object3D.rotation.x = Math.min(Math.max(this.el.object3D.rotation.x, -1.6), 1.6);
      },

      handlePan: function(dX, dY) {
        this.el.object3D.position.x += dX * 0.001;
        this.el.object3D.position.y -= dY * 0.001; 
        this.el.object3D.position.x = Math.min(Math.max(this.el.object3D.position.x, -3), 3);
        this.el.object3D.position.y = Math.min(Math.max(this.el.object3D.position.y, -3), 3);
      },

      handleZoom: function(change, isAbsolute = false) {
        let currentS = this.el.object3D.scale.x;
        let newS = isAbsolute ? (this.startScale + change) : (currentS + change);
        newS = Math.min(Math.max(newS, 0.005), 2.0); 
        this.el.object3D.scale.set(newS, newS, newS);
      }
    });
  </script>
</head>
<body>

  <div id="loading-overlay">
    <div class="loader"></div>
    <p>Loading 15 AR Scenes...</p>
    <button id="start-btn">Enter AR Experience</button>
  </div>

  <div id="ui-layer">
    <div id="lang-container">
      <button class="lang-btn active" onclick="setLanguage('bm')">BM</button>
      <button class="lang-btn" onclick="setLanguage('eng')">ENG</button>
      <button class="lang-btn" onclick="setLanguage('dusun')">DSN</button>
    </div>
    
    <div id="info-panel">
      <button id="replay-btn" onclick="replayAudio()">↻ Replay</button>
      <div id="rotation-hint"></div>
      <div id="scan-guide"></div>
    </div>
  </div>

  <a-scene 
    mindar-image="imageTargetSrc: ./assets/targets/targets.mind; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.0001; warmupTolerance: 10; missTolerance: 10; uiLoading: no;" 
    color-space="sRGB" 
    renderer="colorManagement: true; physicallyCorrectLights: true;" 
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false"
    gltf-model="dracoDecoderPath: https://www.gstatic.com/draco/versioned/decoders/1.5.6/;">

    <a-assets timeout="30000">
      <a-asset-item id="model-1" src="./assets/models/scene-kecil-page1.glb"></a-asset-item>
      <a-asset-item id="model-2" src="./assets/models/scene-kecil-page2.glb"></a-asset-item>
      <a-asset-item id="model-3" src="./assets/models/scene-kecil-page3.glb"></a-asset-item>
      <a-asset-item id="model-4" src="./assets/models/scene-kecil-page4.glb"></a-asset-item>
      <a-asset-item id="model-5" src="./assets/models/scene-kecil-page5.glb"></a-asset-item>
      <a-asset-item id="model-6" src="./assets/models/scene-kecil-page6.glb"></a-asset-item>
      <a-asset-item id="model-7" src="./assets/models/scene-kecil-page7.glb"></a-asset-item>
      <a-asset-item id="model-8" src="./assets/models/scene-kecil-page8.glb"></a-asset-item>
      <a-asset-item id="model-9" src="./assets/models/scene-kecil-page9.glb"></a-asset-item>
      <a-asset-item id="model-10" src="./assets/models/scene-kecil-page10.glb"></a-asset-item>
      <a-asset-item id="model-11" src="./assets/models/scene-kecil-page11.glb"></a-asset-item>
      <a-asset-item id="model-12" src="./assets/models/scene-kecil-page12.glb"></a-asset-item>
      <a-asset-item id="model-13" src="./assets/models/scene-kecil-page13.glb"></a-asset-item>
      <a-asset-item id="model-14" src="./assets/models/scene-kecil-page14.glb"></a-asset-item>
      <a-asset-item id="model-15" src="./assets/models/scene-kecil-page15.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false">
        <a-entity light="type: directional; intensity: 3; castShadow: false; color: #ffffff;" position="0 0 1"></a-entity>
    </a-camera>
    <a-entity light="type: ambient; intensity: 2; color: #ffffff;"></a-entity>

    <a-entity mindar-image-target="targetIndex: 0" id="target-1">
      <a-gltf-model src="#model-1" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 1" id="target-2">
      <a-gltf-model src="#model-2" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>
    
    <a-entity mindar-image-target="targetIndex: 2" id="target-3">
      <a-gltf-model src="#model-3" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>
      
    <a-entity mindar-image-target="targetIndex: 3" id="target-4">
      <a-gltf-model src="#model-4" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 4" id="target-5">
      <a-gltf-model src="#model-5" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>
    
    <a-entity mindar-image-target="targetIndex: 5" id="target-6">
      <a-gltf-model src="#model-6" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 6" id="target-7">
      <a-gltf-model src="#model-7" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>
      
    <a-entity mindar-image-target="targetIndex: 7" id="target-8">
      <a-gltf-model src="#model-8" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 8" id="target-9">
      <a-gltf-model src="#model-9" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>
    
    <a-entity mindar-image-target="targetIndex: 9" id="target-10">
      <a-gltf-model src="#model-10" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 10" id="target-11">
      <a-gltf-model src="#model-11" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>
      
    <a-entity mindar-image-target="targetIndex: 11" id="target-12">
      <a-gltf-model src="#model-12" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 12" id="target-13">
      <a-gltf-model src="#model-13" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>
    
    <a-entity mindar-image-target="targetIndex: 13" id="target-14">
      <a-gltf-model src="#model-14" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 14" id="target-15">
      <a-gltf-model src="#model-15" rotation="0 0 0" position="0 0 0" scale="0.05 0.05 0.05" animation-mixer="clip: *; loop: repeat" free-look-controller></a-gltf-model>
    </a-entity>

  </a-scene>

  <audio id="narrator-audio" preload="auto"></audio>

  <script>
    const scene = document.querySelector('a-scene');
    const audioPlayer = document.getElementById('narrator-audio');
    const scanGuide = document.getElementById('scan-guide');
    const rotHint = document.getElementById('rotation-hint');
    const replayBtn = document.getElementById('replay-btn');
    
    // UI TEXT DATA
    const uiText = {
      bm: {
        scan: "Sila imbas halaman buku...",
        playing: "Memainkan Halaman",
        hint: "1 Jari: Pusing • 2 Jari: Gerak & Zum",
        replay: "↻ Mainkan Semula"
      },
      eng: {
        scan: "Please scan a book page...",
        playing: "Playing Page",
        hint: "1 Finger: Orbit • 2 Fingers: Pan & Zoom",
        replay: "↻ Replay Audio"
      },
      dusun: {
        scan: "Imbaso nopo o surat...",
        playing: "Popo-uni Surat",
        hint: "1 Tunturu: Pousik • 2 Tunturu: Gura & Padang",
        replay: "↻ Uni'on Kawagu"
      }
    };

    let currentLang = 'bm'; 
    let activePage = null; 
    let debounceTimer = null; 

    // --- 1. INITIALIZATION ---
    scene.addEventListener('loaded', () => {
        document.querySelector('.loader').style.display = 'none';
        document.querySelector('p').style.display = 'none';
        document.getElementById('start-btn').style.display = 'block';
        updateUI(); 
    });

    document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        scene.systems['mindar-image-system'].start(); 
    });

    // --- 2. MULTI-LANGUAGE LOGIC ---
    window.setLanguage = (lang) => {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        updateUI();
        if (activePage !== null) playAudio(activePage);
    };

    function updateUI() {
        rotHint.innerText = uiText[currentLang].hint;
        replayBtn.innerText = uiText[currentLang].replay; 

        if (activePage === null) {
            scanGuide.innerText = uiText[currentLang].scan;
            replayBtn.style.display = "none"; 
        } else {
            scanGuide.innerText = `${uiText[currentLang].playing} ${activePage}`;
            replayBtn.style.display = "block"; 
        }
    }

    // --- 3. AUDIO LOGIC ---
    async function playAudio(pageNumber) {
        let filename = "";
        
        if (currentLang === 'bm') {
            filename = `Page${pageNumber}.m4a`; 
        } else if (currentLang === 'eng') {
            filename = `Page${pageNumber}.mp3`;
        } else if (currentLang === 'dusun') {
            filename = `page${pageNumber}.m4a`; 
        }

        const newSrc = `./assets/audio/${currentLang}/${filename}`;
        
        if (!audioPlayer.paused && audioPlayer.src.includes(filename)) return;

        try {
            audioPlayer.src = newSrc;
            updateUI(); 
            rotHint.style.display = "block"; 
            await audioPlayer.play();
        } catch (err) {
            if (err.name !== 'AbortError') console.error("Audio error:", err);
        }
    }

    window.replayAudio = async () => {
        if (activePage !== null) {
            audioPlayer.currentTime = 0; 
            try {
                await audioPlayer.play();
            } catch (err) {
                console.error("Replay error:", err);
            }
        }
    };

    function stopAudio() {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        updateUI();
        rotHint.style.display = "none";
        replayBtn.style.display = "none"; 
    }

    // --- 4. STRICT TARGET EVENTS ---
    for (let i = 1; i <= 15; i++) {
        const targetElement = document.querySelector(`[mindar-image-target="targetIndex: ${i-1}"]`);
        
        if (targetElement) {
            targetElement.addEventListener("targetFound", event => {
                if (activePage !== null && activePage !== i) {
                    return;
                }

                // --- RESET TRANSFORMATIONS (Animation mixer is already on target, so we don't need to add it) ---
                const model = targetElement.querySelector('a-gltf-model');
                if (model) {
                    model.object3D.position.set(0, 0, 0);
                    model.object3D.rotation.set(0, 0, 0);
                    model.object3D.scale.set(0.05, 0.05, 0.05);
                }
                // ----------------------------------

                if (debounceTimer) clearTimeout(debounceTimer);

                debounceTimer = setTimeout(() => {
                    activePage = i; 
                    playAudio(i);
                }, 500); 
            });

            targetElement.addEventListener("targetLost", event => {
                if (activePage === i) {
                    if (debounceTimer) { clearTimeout(debounceTimer); debounceTimer = null; }
                    activePage = null; 
                    stopAudio();
                }
            });
        }
    }
  </script>
</body>
</html>